#!/bin/sh

########################################################################
#                                                                      #
#   Update script v3.02                                                #
#   (c) by Tobse (cthullu@protonmail.com) in 2017                      #
#                                                                      #
#   This script must be located on a USB stick and mounted on /jffs.   #
#   All scripts must be "chmod ugo+x" in order to be executable.       #
#   You might wanna call it by cron similar to that (mind "root" in    #
#   the following line):                                               #
#   0 3 * * * root /jffs/usr/bin/update 2>&1                           #
#                                                                      #
########################################################################

echo Update invoked.

# load config
DIRNAME="$( cd "$( dirname "$0" )" && pwd )"
source $DIRNAME/config
if [ -f "$DIRNAME/myconfig" ]; then
  echo -e "\033[1;36mIncluding personal config override.\033[0m"
  source $DIRNAME/myconfig
fi

if [ -f "$DIRNAME/*.update" ]; then
  echo Deleting orphaned update files
  rm $DIRNAME/*.update
fi

FILENAME=config
echo Downloading $FILENAME script...
curl -m 120 -ks $GITHUBURL/jffs/usr/bin/${FILENAME} -o $DIRNAME/${FILENAME}.update
if [ -f "$DIRNAME/$FILENAME" ]; then
  if [ `wc -c "$DIRNAME/$FILENAME.update" | awk '{print $1}'` -gt 1024 ]; then
    echo Replacing file...
    mv $DIRNAME/${FILENAME}.update $DIRNAME/${FILENAME}
  fi
fi

FILENAME=checkcon
echo Downloading $FILENAME script...
curl -m 120 -ks $GITHUBURL/jffs/usr/bin/${FILENAME} -o $DIRNAME/${FILENAME}.update
if [ -f "$DIRNAME/$FILENAME" ]; then
  if [ `wc -c "$DIRNAME/$FILENAME.update" | awk '{print $1}'` -gt 1024 ]; then
    echo Replacing file...
    mv $DIRNAME/${FILENAME}.update $DIRNAME/${FILENAME}
  fi
fi

FILENAME=speedcheck
echo Downloading $FILENAME script...
curl -m 120 -ks $GITHUBURL/jffs/usr/bin/${FILENAME} -o $DIRNAME/${FILENAME}.update
if [ -f "$DIRNAME/$FILENAME" ]; then
  if [ `wc -c "$DIRNAME/$FILENAME.update" | awk '{print $1}'` -gt 1024 ]; then
    echo Replacing file...
    mv $DIRNAME/${FILENAME}.update $DIRNAME/${FILENAME}
  fi
fi

FILENAME=vpn
echo Downloading $FILENAME script...
curl -m 120 -ks $GITHUBURL/jffs/usr/bin/${FILENAME} -o $DIRNAME/${FILENAME}.update
if [ -f "$DIRNAME/$FILENAME" ]; then
  if [ `wc -c "$DIRNAME/$FILENAME.update" | awk '{print $1}'` -gt 1024 ]; then
    echo Replacing file...
    mv $DIRNAME/${FILENAME}.update $DIRNAME/${FILENAME}
  fi
fi

FILENAME=killvpn
echo Downloading $FILENAME script...
curl -m 120 -ks $GITHUBURL/jffs/usr/bin/${FILENAME} -o $DIRNAME/${FILENAME}.update
if [ -f "$DIRNAME/$FILENAME" ]; then
  if [ `wc -c "$DIRNAME/$FILENAME.update" | awk '{print $1}'` -gt 1024 ]; then
    echo Replacing file...
    mv $DIRNAME/${FILENAME}.update $DIRNAME/${FILENAME}
  fi
fi

FILENAME=update
echo Downloading $FILENAME script...
curl -m 120 -ks $GITHUBURL/jffs/usr/bin/${FILENAME} -o $DIRNAME/${FILENAME}.update
if [ -f "$DIRNAME/$FILENAME" ]; then
  if [ `wc -c "$DIRNAME/$FILENAME.update" | awk '{print $1}'` -gt 1024 ]; then
    echo Replacing file...
    mv $DIRNAME/${FILENAME}.update $DIRNAME/${FILENAME}
  fi
fi